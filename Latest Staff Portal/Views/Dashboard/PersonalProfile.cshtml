@using Latest_Staff_Portal.Models
@model Latest_Staff_Portal.ViewModel.EmployeeView
@{
    ViewBag.Title = "Dashboard";
    Layout = "~/Views/Shared/Sitemaster.cshtml";
    var imgSrc = "";
    var CustBal = "";
    if (Session["Username"] == null)
    {
        Html.Action("Login", "Login");
    }
    else
    {


        <style>


            .profile-container {
                background-color: white;
                border-radius: var(--border-radius);
                box-shadow: var(--box-shadow);
                margin-bottom: 2rem;
                overflow: hidden;
            }

            .profile-sidebar {
                /*background-color: var(--light-bg);*/
                padding: 2rem 1rem;
                /*border-radius: var(--border-radius);*/
                text-align: center;
            }

            .profile-picture {
                position: relative;
                width: 150px;
                height: 150px;
                border-radius: 50%;
                margin: 0 auto 1.5rem;
                overflow: hidden;
                box-shadow: var(--box-shadow);
                transition: var(--transition);
            }

                .profile-picture:hover {
                    transform: scale(1.05);
                }

            .profile-picture-edit {
                position: absolute;
                bottom: 0;
                right: 0;
                background-color: var(--primary-color);
                color: var(--text-on-primary);
                border-radius: 50%;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            }

            .profile-section {
                border: none;
                margin-bottom: 1rem;
                border-radius: var(--border-radius);
                box-shadow: var(--box-shadow);
                overflow: hidden;
            }

            .profile-section-header {
                background-color: #f4f4f4;
                color: var(--text-on-primary);
                padding: 1rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                transition: var(--transition);
            }

                .profile-section-header:hover {
                    background-color: #8cc43c;
                    color: #fff;
                }

                .profile-section-header h6 {
                    margin: 0;
                    font-weight: 600;
                    font-size: 1rem;
                }

                .profile-section-header i {
                    margin-right: 10px;
                }

            .profile-section-body {
                padding: 1.5rem;
                background-color: white;
            }

            .info-row {
                display: flex;
                margin-bottom: 1rem;
                align-items: center;
            }

            .info-label {
                font-weight: 600;
                min-width: 140px;
                color: var(--secondary-color);
            }

            .info-value {
                color: #555;
            }

            .btn-profile {
                transition: var(--transition);
                font-weight: 500;
                margin-bottom: 0.75rem;
            }

                .btn-profile:hover {
                    transform: translateY(-2px);
                }

            .btn-primary-custom {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
                color: var(--text-on-primary);
            }

                .btn-primary-custom:hover {
                    background-color: var(--primary-dark);
                    border-color: var(--primary-dark);
                    color: white;
                }

            .btn-secondary-custom {
                background-color: #050505;
                border-color: var(--secondary-color);
                color: white;
            }

                .btn-secondary-custom:hover {
                    color: white;
                    background-color: var(--secondary-color);
                }

            .qualifications-table {
                width: 100%;
                border-collapse: collapse;
            }

                .qualifications-table th {
                    background-color: var(--light-bg);
                    padding: 0.75rem;
                    text-align: left;
                    font-weight: 600;
                }

                .qualifications-table td {
                    padding: 0.75rem;
                    border-top: 1px solid #dee2e6;
                }

            .attachments-list {
                margin-top: 1.5rem;
            }

            .attachment-item {
                display: flex;
                align-items: center;
                padding: 0.75rem;
                border: 1px solid #dee2e6;
                border-radius: var(--border-radius);
                margin-bottom: 0.5rem;
                transition: var(--transition);
            }

                .attachment-item:hover {
                    background-color: var(--light-bg);
                }

            .attachment-icon {
                margin-right: 1rem;
                color: var(--primary-color);
            }

            /* Animations for accordion */
            .collapse {
                transition: height 0.3s ease;
            }

            /* Responsive adjustments */
            @@media (max-width: 768px) {
                .profile-sidebar {
                    margin-bottom: 1.5rem;
                }

                .info-row {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .info-label {
                    margin-bottom: 0.25rem;
                }
            }
        </style>

        <div class="page-header">
            <div class="row">
                <div class="col-sm-12">
                    <h3 class="page-title mb-3">
                        <i class="fa fa-user-circle mr-2"></i>My Profile
                    </h3>
                    <hr />
                </div>
            </div>
        </div>

        <div class="row profile-container">
            <div class=" col-md-4">
                <div class="profile-sidebar card mt-2">
                    <div class="profile-picture">
                        <div id="divProfPic"></div>
                       
                    </div>

                    <h4 class="mt-3 mb-1">@Model.FirstName @Model.MiddleName @Model.LastName</h4>
                    <p class="text-muted">@Model.Title</p>

                    <hr />

                    <div class="profile-actions">
                        <button class="btn btn-primary-custom btn-profile w-100" onclick="ChangePasswordLink()">
                            <i class="fa fa-lock mr-2"></i>Change Password
                        </button>

                        <button class="btn btn-secondary-custom btn-profile w-100" data-toggle="modal" data-target="#myModalProfile">
                            <i class="fa fa-image mr-2"></i>Change Profile Picture
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div id="accordion" role="tablist" aria-multiselectable="true">
                    <!-- Personal Information Section -->
                    <div class="mt-3 profile-section">
                        <div class="profile-section-header" id="headingOne" data-toggle="collapse" href="#collapseOne" aria-controls="collapseOne" aria-expanded="true">
                            <i class="fa fa-user"></i>
                            <h6>Personal Information</h6>
                        </div>
                        <div id="collapseOne" class="card collapse show" aria-labelledby="headingOne" data-parent="#accordion">
                            <div class="profile-section-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="info-row">
                                            <div class="info-label">Gender:</div>
                                            <div class="info-value">@Model.Gender</div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="info-row">
                                            <div class="info-label">Marital Status:</div>
                                            <div class="info-value">@Model.Marital_Status</div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="info-row">
                                            <div class="info-label">Nationality:</div>
                                            <div class="info-value">@Model.County_of_Origin</div>
                                        </div>
                                    </div>

                                    <!-- Added fields as requested -->
                                    <div class="col-md-6">
                                        <div class="info-row">
                                            <div class="info-label">ID Number:</div>
                                            <div class="info-value">@(Model.ID_Number ?? "Not provided")</div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="info-row">
                                            <div class="info-label">NSSF Number:</div>
                                            <div class="info-value">@(Model.Social_Security_No ?? "Not provided")</div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="info-row">
                                            <div class="info-label">NHIF Number:</div>
                                            <div class="info-value">@(Model.N_H_I_F_No ?? "Not provided")</div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="info-row">
                                            <div class="info-label">KRA PIN:</div>
                                            <div class="info-value">@(Model.P_I_N ?? "Not provided")</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-row">
                                            <div class="info-label">Country of Origin:</div>
                                            <div class="info-value">@(Model.County_of_Origin_Name ?? "Not provided")</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-row">
                                            <div class="info-label">KRA PIN:</div>
                                            <div class="info-value">@(Model.P_I_N ?? "Not provided")</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-row">
                                            <div class="info-label">Postal Code:</div>
                                            <div class="info-value">@(Model.Post_Code ?? "Not provided")</div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="info-row">
                                            <div class="info-label">Bank Name:</div>
                                            <div class="info-value">
                                                @(Model.Bank_Name ?? "Not provided")
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-row">
                                            <div class="info-label">Account No:</div>
                                            <div class="info-value">@(Model.BankAccountNumber ?? "Not provided")</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Details Section -->
                <div class="profile-section">
                    <div class="profile-section-header" id="headingTwo" data-toggle="collapse" href="#collapseTwo" aria-controls="collapseTwo" aria-expanded="false">
                        <i class="fa fa-address-card"></i>
                        <h6>Contact Details</h6>
                    </div>
                    <div id="collapseTwo" class="card collapse" aria-labelledby="headingTwo" data-parent="#accordion">
                        <div class="profile-section-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-row">
                                        <div class="info-label">Postal Code:</div>
                                        <div class="info-value">@Model.Post_Code</div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="info-row">
                                        <div class="info-label">Nationality:</div>
                                        <div class="info-value">@Model.County_of_Origin</div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="info-row">
                                        <div class="info-label">Company Email:</div>
                                        <div class="info-value">@Model.Company_E_Mail</div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="info-row">
                                        <div class="info-label">Mobile No.:</div>
                                        <div class="info-value">@Model.Mobile_Phone_No</div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="info-row">
                                        <div class="info-label">Work Tel.:</div>
                                        <div class="info-value">@Model.Phone_No_2</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @*Next of kin*@
                <div class="profile-section">
                    <div class="profile-section-header" id="headingThree" data-toggle="collapse" href="#collapseThree" aria-controls="collapseThree" aria-expanded="false">
                        <i class="fa fa-users"></i>
                        <h6>Next of Kin</h6>
                    </div>
                    <div id="collapseThree" class="card collapse" aria-labelledby="headingThree" data-parent="#accordion">
                        <div class=" profile-section-body">
                            <div class="d-flex justify-content-between mb-4">
                                <h5>Next of kin</h5>
                                <button class="btn btn-sm btn-primary action-buttons2" onclick="AddNextofKin()">
                                    <i class="fa fa-plus mr-1"></i>Add Next of Kin
                                </button>
                            </div>
                            <div id="nextOfKin"></div>
                           @* <div class="card">
                                <div class="d-flex px-4 justify-content-between mb-4 mt-2">
                                    <h5>Documents</h5>
                                    <button class="btn btn-sm btn-primary-custom" onclick="AddAttachment()">
                                        <i class="fa fa-upload mr-1"></i> Upload Document
                                    </button>
                                </div>
                                <div id="divAttachDocs"></div>
                            </div>*@
                        </div>

                    </div>
                </div>


                @*Qualifications Section*@
                <div class="profile-section">
                    <div class="profile-section-header" id="headingFour" data-toggle="collapse" href="#collapseFour" aria-controls="collapseFour" aria-expanded="false">
                        <i class="fa fa-graduation-cap"></i>
                        <h6>Qualifications</h6>
                    </div>
                    <div id="collapseFour" class="card collapse" aria-labelledby="headingFour" data-parent="#accordion">
                        <div class="profile-section-body">
                            <div class="d-flex justify-content-between mb-4">
                                <h5>Qualifications</h5>
                                <button class="btn btn-sm btn-primary btn-sm action-buttons2" onclick="AddQualification()">
                                    <i class="fa fa-plus mr-1"></i> Add Qualification
                                </button>
                            </div>

                            <div id="EmpQualifications"></div>
                            <div class="card mt-2">
                                <div class="d-flex px-4 justify-content-between mb-4 mt-2">
                                    <h5>Documents</h5>
                                    <button class="btn btn-sm btn-primary-custom" onclick="AddAttachment()">
                                        <i class="fa fa-upload mr-1"></i> Upload Document
                                    </button>
                                </div>
                                <div id="divAttachDocs"></div>
                            </div>
                        </div>
                       
                    </div>
                </div>



                <div class="text-center">
                    <button class="btn action-buttons2 btn-profile w-30" onclick="LoadUpdatePersonalInfoForm()">
                        <i class="fa fa-edit mr-2"></i>Update Personal Info & Contact
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Picture Modal -->
        <div class="modal fade" id="myModalProfile" tabindex="-1" role="dialog" aria-labelledby="profileModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header" style="">
                        <h5 class="modal-title" id="profileModalLabel">Update Profile Picture</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="fileAttachment">Select Image</label>
                            <input type="file" class="form-control-file" id="fileAttachment" accept="image/*">
                            <small class="form-text text-muted">Recommended size: 300x300 pixels. Maximum file size: 5MB</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary-custom" onclick="UploadProfilePic()">Upload</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Modal for other forms -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header" style="">
                        <h5 class="modal-title" id="labelF"></h5>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="modalBody">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        @*Update profile modal*@
        <!-- Update Personal Info Modal -->
        <div class="modal fade" id="updatePersonalInfoModal" tabindex="-1" role="dialog" aria-labelledby="updatePersonalInfoLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: var(--primary-color);">
                        <h5 class="modal-title" id="updatePersonalInfoLabel">Update Personal Information</h5>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="personalInfoForm">
                            <div class="row">
                                @*<div class="col-md-6">*@
                                @*<div class="form-group">
                                        <label>Gender</label>
                                        <select class="form-control" id="Gender">
                                            <option value="Male" @(Model.Gender == "Male" ? "selected" : "")>Male</option>
                                            <option value="Female" @(Model.Gender == "Female" ? "selected" : "")>Female</option>
                                        </select>
                                    </div>*@
                                @*<div class="form-group">
                                        <label>Nationality</label>
                                        <input type="text" class="form-control" id="CountyofOriginName" value="@Model.County_of_Origin">
                                    </div>*@
                                @*<div class="form-group">
                                        <label>ID Number</label>
                                        <input type="text" class="form-control" id="IdNumber" value="@Model.ID_Number">
                                    </div>
                                    <div class="form-group">
                                        <label>NSSF Number</label>
                                        <input type="text" class="form-control" id="NSSFNumber" value="@Model.Social_Security_No">
                                    </div>*@
                                @*</div>*@
                                @*<div class="form-group">
                                        <label>NHIF Number</label>
                                        <input type="text" class="form-control" id="NHIFNumber" value="@Model.N_H_I_F_No">
                                    </div>
                                    <div class="form-group">
                                        <label>KRA PIN</label>
                                        <input type="text" class="form-control" id="KRAPin" value="@Model.P_I_N">
                                    </div>*@
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Bank Name</label>
                                        <input type="text" class="form-control" id="BankName" value="@Model.Bank_Name">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Account Number</label>
                                        <input type="text" class="form-control" id="BankAccountNo" value="@Model.BankAccountNumber">
                                    </div>
                                </div>
                                @*<div class="form-group">
                                        <label>Postal Code</label>
                                        <input type="text" class="form-control" id="PostCode" value="@Model.Post_Code">
                                    </div>*@
                                @*</div>*@
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Marital Status</label>
                                        <select class="form-control" id="MaritalStatus" name="Marital_Status">
                                            <option value="">-- Select --</option>
                                            <option value="Single" @(Model.Marital_Status == "Single" ? "selected" : "")>Single</option>
                                            <option value="Married" @(Model.Marital_Status == "Married" ? "selected" : "")>Married</option>
                                            <option value="Divorced" @(Model.Marital_Status == "Divorced" ? "selected" : "")>Divorced</option>
                                            <option value="Prefer not to say" @(Model.Marital_Status == "Prefer not to say" ? "selected" : "")>Widowed</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Mobile Number</label>
                                        <input type="tel" class="form-control" id="MobilePhoneNo" value="@Model.Mobile_Phone_No">
                                    </div>
                                    @*<div class="form-group">
                                            <label>Work Telephone</label>
                                            <input type="tel" class="form-control" id="MobilePhoneNo" value="@Model.Mobile_Phone_No">
                                        </div>*@
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary-custom" onclick="SubmitPersonalInfo()">Update Information</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Document View Modal -->
        <div class="modal fade" id="myModalAttachment" tabindex="-1" role="dialog" aria-labelledby="attachmentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: var(--primary-color);">
                        <h5 class="modal-title" id="attachmentModalLabel">Document Viewer</h5>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="modalAttachmentBody">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="~/SiteJS/DashboardJS.js"></script>
        <script src="~/assets/js/ShowProgression.js"></script>
        <script type="text/javascript">


                $(document).ready(function () {
                    LoadProfilePic();
                    LoadNextOfKin();

                    $('.profile-section-header').on('click', function () {
                        const isExpanded = $($(this).attr('href')).hasClass('show');
                        $(this).find('i:first').toggleClass('fa-chevron-down fa-chevron-right', !isExpanded);
                    });

                });
                function LoadProfilePic() {
                    ShowProgress();
                    $.ajax({
                        url: "/Dashboard/ProfilePicture",
                        type: "POST",
                        datatype: "json",
                        cache: false,
                        contentType: "application/json; charset = utf-8",
                        processData: false,
                        data: JSON.stringify({ gender:`@Model.Gender` }),

                        async: true,
                        type: "GET",
                        dataType: 'HTML',
                        contentType: false,
                        processData: false,

                        success: function (data) {
                            $("#divProfPic").html(data);
                            HideProgress();
                            LoadEmployeeQualifications()
                            LoadNextOfKin();
                        },
                        error: function () {
                            HideProgress();
                            Swal.fire('Warning', 'There is some problem to process your request. Please try after some time', 'warning');
                            LoadEmployeeQualifications();
                            LoadNextOfKin();
                        }
                    });
                }
                var UploadProfilePic = function () {
                    ShowProgress();
                    var filename; var base64String; var filetype;
                    var files = document.getElementById('fileAttachment').files;
                    if (files.length) {
                        var file = files[0];
                        var blob = file.slice();
                        filetype = file.type;
                        filename = file.name;
                        var reader = new FileReader();
                        reader.onloadend = function (evt) {
                            if (evt.target.readyState == FileReader.DONE) { // DONE == 2
                                var cont = evt.target.result
                                base64String = getB64Str(cont);
                                //Send the JSON array to Controller using AJAX.
                                $.ajax({
                                    type: "POST",
                                    url: "/Dashboard/SubmitProfilePicAttachment",
                                    //data: data,
                                    data: JSON.stringify({ base64Upload: base64String, fileName: filename, Extn: filetype }),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    success: function (data) {
                                        if (data.success) {
                                            HideProgress();
                                            LoadProfilePic();
                                            $("#myModalProfile").modal("hide");
                                        }
                                        else {
                                            Swal.fire('Warning', data.message, 'warning');
                                            HideProgress();
                                        }
                                    },
                                    error: function (err) {
                                        HideProgress();
                                        Swal.fire('Warning', err, 'warning');
                                    }
                                });
                            }
                        };
                        reader.readAsArrayBuffer(blob);
                    }
                };
                var LoadEmployeeQualifications = function () {
                    //ShowProgress();
                    $.ajax({
                        async: true,
                        type: "GET",
                        dataType: 'HTML',
                        contentType: false,
                        processData: false,
                        url: "/Dashboard/EmployeeQualification",
                        success: function (data) {
                            $("#EmpQualifications").empty().html(data);
                            HideProgress();
                            GetDocumentAttachments();
                        },
                        error: function (err) {
                            HideProgress();
                            Swal.fire("There is some problem to process your request. Please try after some time");
                            GetDocumentAttachments();
                        }
                    });
                };


                var LoadNextOfKin = function () {
                    //ShowProgress();
                    $.ajax({
                        async: true,
                        type: "GET",
                        dataType: 'HTML',
                        contentType: false,
                        processData: false,
                        url: "/Dashboard/NextOfKin",
                        success: function (data) {
                            $("#nextOfKin").empty().html(data);
                            HideProgress();
                            GetDocumentAttachments();
                        },
                        error: function (err) {
                            HideProgress();
                            Swal.fire("There is some problem to process your request. Please try after some time");
                            GetDocumentAttachments();
                        }
                    });
                };

                function LoadUpdatePersonalInfoForm() {
                    // If dynamic loading is needed, make AJAX call here
                    $('#updatePersonalInfoModal').modal('show');
                }

                function SubmitPersonalInfo() {
                    var formData = {
                        //Gender: $('#Gender').val(),
                        //CountyofOriginName: $('#CountyofOriginName').val(),
                        //IdNumber: $('#IdNumber').val(),
                        //NSSFNumber: $('#NSSFNumber').val(),
                        //NHIFNumber: $('#NHIFNumber').val(),
                        //KRAPin: $('#KRAPin').val(),
                        //PhoneNo: $('#PhoneNo').val(),
                        Marital_Status: $('#MaritalStatus').val(),
                        No: `@Model.No`,
                        Bank_Name: $('#BankName').val(),
                        Bank_Account_Number: $('#BankAccountNo').val(),
                        Post_Code: $('#PostCode').val(),
                        Mobile_Phone_No: $('#MobilePhoneNo').val()
                    };
                    console.log(formData);

                    Swal.fire({
                        title: 'Confirm Update',
                        text: 'Are you sure you want to update your personal information?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, update!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            ShowProgress();
                            $.ajax({
                                url: '/Dashboard/UpdatePersonalInfo',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify(formData),
                                success: function (response) {
                                    HideProgress();
                                    if (response.success) {
                                        Swal.fire('Success', 'Information updated successfully!', 'success');
                                        $('#updatePersonalInfoModal').modal('hide');
                                        setTimeout(() => location.reload(), 1500);
                                    } else {
                                        Swal.fire('Error', response.message || 'Update failed', 'error');
                                    }
                                },
                                error: function (xhr) {
                                    HideProgress();
                                    Swal.fire('Error', xhr.responseText || 'Update failed', 'error');
                                }
                            });
                        }
                    });
                }

                var AddQualification = function () {
                     ShowProgress();
                     $.ajax({
                         async: true,
                         type: "GET",
                         dataType: "html",
                         url: '/Dashboard/AddQualification',
                         success: function (data) {
                             $("#modalBody").html(data);
                             HideProgress();
                             $("#myModal").modal("show");
                         },
                         error: function (err) {
                             HideProgress();
                             Swal.fire('Warning', err.responseText, 'warning');
                         }
                     });
                }

                var AddNextofKin = function () {
                    $("#labelF").text("New Next of Kin");
                     ShowProgress();
                     $.ajax({
                         async: true,
                         type: "GET",
                         dataType: "html",
                         url: '/Dashboard/AddNextOfKin',
                         success: function (data) {
                             $("#modalBody").html(data);
                             HideProgress();
                             $("#myModal").modal("show");
                         },
                         error: function (err) {
                             HideProgress();
                             Swal.fire('Warning', err.responseText, 'warning');
                         }
                     });
                }

                function SubmitNextOfKin() {
                    var isValid = true;

                    var surname = $("#surname").val();
                    var otherNames = $("#otherNames").val();
                    var dob = $("#dob").val();
                    var phoneNo = $("#phoneNo").val();
                    var email = $("#email").val();
                    var idNo = $("#idNo").val();
                    var gender = $("#gender").val();
                    var relationship = $("#relationship").val();

                    if (!surname) {
                        Swal.fire('Warning', 'Please enter Surname.', 'warning');
                        isValid = false;
                    } else if (!otherNames) {
                        Swal.fire('Warning', 'Please enter Other Names.', 'warning');
                        isValid = false;
                    } else if (!dob) {
                        Swal.fire('Warning', 'Please select Date of Birth.', 'warning');
                        isValid = false;
                    } else if (!phoneNo) {
                        Swal.fire('Warning', 'Please enter Phone Number.', 'warning');
                        isValid = false;
                    } else if (!email) {
                        Swal.fire('Warning', 'Please enter Email Address.', 'warning');
                        isValid = false;
                    } else if (!idNo) {
                        Swal.fire('Warning', 'Please enter ID or Passport Number.', 'warning');
                        isValid = false;
                    } else if (!gender) {
                        Swal.fire('Warning', 'Please select Gender.', 'warning');
                        isValid = false;
                    } else if (!relationship) {
                        Swal.fire('Warning', 'Please select Relationship.', 'warning');
                        isValid = false;
                    }

                if (!isValid) {
                    return;
                }

                var nextofKinLine = {
                Employee_Code: '@Model.No',
                //Type: 'Next of Kin',
                Relationship: relationship,
                SurName: surname,
                Other_Names: otherNames,
                Date_Of_Birth: dob,
                Home_Tel_No: phoneNo,
                E_mail: email,
                Gender: gender,
                ID_No_Passport_No: idNo
            };

                    console.log(nextofKinLine);

                ShowProgress();
                $.ajax({
                    type: "POST",
                    url: "/Dashboard/SubmitNextOfKin",
                    data: JSON.stringify(nextofKinLine),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        HideProgress();
                        if (data.success) {
                            $("#myModal").modal("hide");
                            Swal.fire('Success', data.message, 'success');
                            LoadNextOfKin();
                        } else {
                            Swal.fire('Warning', data.message, 'warning');
                        }
                    },
                    error: function (err) {
                        HideProgress();
                        Swal.fire('Warning', err.responseText, 'warning');
                    }
                });
            }

                var SubmitQualification = function () {

                    var QualificationType = $("#QualificationType").val();
                    var QualificationCode = $("#QualificationCode").val();
                    var Description = $("#Description").val();
                    var CourseType = $("#CourseType").val();
                    var FromDate = $("#FromDate").val();
                    var ToDate = $("#ToDate").val();
                    var GradDate = $("#GradDate").val();
                    var Type = $("#Type").val();
                    var InstitutionCompany = $("#InstitutionCompany").val();
                    var ScoreID = $("#ScoreID").val();

                    var isValid = true;

                    //validations
                    if (!QualificationType) {
                        Swal.fire('Warning', 'Select Qualification Type', 'warning');
                        var isValid = false;
                    }

                    if (!isValid) {
                        return
                    }

                    var qualificationData = {
                        QualificationType: QualificationType,
                        QualificationCode: QualificationCode,
                        Description: Description,
                        CourseType: CourseType,
                        FromDate: FromDate,
                        ToDate: ToDate,
                        GradDate: GradDate,
                        Type: Type,
                        InstitutionCompany: InstitutionCompany,
                        ScoreID: ScoreID
                    };

                    ShowProgress();

                    // Send data via AJAX
                    $.ajax({
                        type: "POST",
                        url: "/Dashboard/SubmitQualification",
                        data: JSON.stringify(qualificationData),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (data) {
                            HideProgress();
                            if (data.success) {
                                console.log(data.succes)
                                /*ViewDoc(data.message);*/
                                Swal.fire('Success', 'Record submitted successfully.', 'success');
                                window.location.reload();
                            } else {
                                Swal.fire('Warning', data.message, 'warning');
                            }
                        },
                        error: function (err) {
                            HideProgress();
                            Swal.fire('Error', 'An error occurred while submitting the request.', 'error');
                        }
                    });


                }

                var GetDocumentAttachments = function () {
                    var DocNo = `@Model.No`;
                    var status = 'Open';

	                $.ajax({
		                async: true,
		                type: "POST",
		                datatype: "json",
		                contentType: "application/json; charset = utf-8",
		                processData: false,
                        data: JSON.stringify({ DocNo: DocNo, documentStatus: status }),
                        url: "/Common/EdmsDocumentAttachmentList",
		                success: function (data) {
			                $("#divAttachDocs").html(data);
		                },
		                error: function () {
			                Swal.fire("There is some problem to process your request. Please try after some time");
		                }
	                });
                };

                var AddAttachment = function () {
                    $("#labelF").text("File Upload");
                    ShowProgress();
                    $.ajax({
                        async: true,
                        type: "GET",
                        datatype: "html",
                        url: '/Common/FileUploadForm',
                        success: function (data) {
                            $("#modalBody").html(data);
                            HideProgress();
                            $("#myModal").modal("show");
                        },
                        error: function (err) {
                            HideProgress();
                            Swal.fire('Warning', err, 'warning');
                        }
                    });
                };

                var SaveAttachmentFile = function () {
	                var DocNo = `@Model.No`;
                    var filename;
                    var base64String;
                    var filetype;
                    var files = document.getElementById('AttachmentFile').files;
	                if (files.length) {
		                var file = files[0];
                        if (file.size > 50000000) {
                            Swal.fire('Warning', 'Please only files less than 50MB allowed. Thanks!!', 'warning');
                        }
		                else {
			                var blob = file.slice();
			                filetype = file.type;
			                filename = file.name;
			                var reader = new FileReader();
			                reader.onloadend = function (evt) {
				                if (evt.target.readyState == FileReader.DONE) {
					                var cont = evt.target.result
					                base64String = getB64Str(cont);
					                ShowProgress();
					                $.ajax({
						                type: "POST",
						                url: "/Common/SaveAttachedFile",
                                        data: JSON.stringify({ DocNo: DocNo, base64Upload: base64String, fileName: filename, Extn: filetype, module: "HR", subModule: "Employee Management", documentType: "Employee Qualification" }),
						                contentType: "application/json; charset=utf-8",
						                dataType: "json",
						                success: function (data) {
							                if (data.success) {
								                HideProgress();
								                $("#myModal").modal("hide");
								                Swal.fire('Success', data.message, 'success');
                                                GetDocumentAttachments();
							                }
							                else {
                                                GetDocumentAttachments();
								                Swal.fire('Warning', data.message, 'warning');
								                HideProgress();
							                }
						                },
						                error: function (err) {
							                HideProgress();
							                Swal.fire('Warning', err, 'warning');
						                }
					                });
				                }
			                };
			                reader.readAsArrayBuffer(blob);
		                }
	                }
                };
                function getB64Str(buffer) {
                    var binary = '';
                    var bytes = new Uint8Array(buffer);
                    var len = bytes.byteLength;
                    for (var i = 0; i < len; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    return window.btoa(binary);
                }
                var DeleteAttachment = function (docId, line) {
                    ShowProgress();
                    $.ajax({
                        async: true,
                        type: "POST",
                        dataType: "json",
                        data: JSON.stringify({
                            documentId: docId,
                            lineNo: line
                        }),
                        contentType: "application/json; charset=utf-8",
                        processData: false,
                        url: '/Common/RemoveFileAsync',
                        success: function (data) {
                            HideProgress();
                            if (data.success === true) {
                                Swal.fire('Success', data.message, 'success');
                                GetDocumentAttachments();
                            } else {
                                Swal.fire('Error', data.message, 'error');
                                GetDocumentAttachments();
                            }
                        },
                        error: function (err) {
                            HideProgress();
                            Swal.fire('Warning', err.responseText, 'warning');
                        }
                    });
                };

                var ViewAttachment = function (moduleCheck, docNo, docId) {
                    $.ajaxSetup({ cache: false });
                    ShowProgress();
                    var viewer = $("#modalAttachmentBody");
                    viewer.empty();

                    $.ajax({
                        url: '/Common/GetEdmsDocuments',
                        type: "GET",
                        datatype: "json",
                        cache: false,
                        contentType: "application/json; charset=utf-8",
                        data: {
                            module: moduleCheck,
                            documentNo: docNo,
                            documentType: "Quote",
                            documentId: docId
                        },
                        success: function (data) {
                            if (data.success) {
                                if (data.base64) {
                                    var mimeType = data.mimeType || 'application/pdf';

                                    if (mimeType.startsWith('application/pdf')) {

                                        var byteCharacters = atob(data.base64);
                                        var byteNumbers = new Array(byteCharacters.length);
                                        for (var i = 0; i < byteCharacters.length; i++) {
                                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                                        }
                                        var byteArray = new Uint8Array(byteNumbers);
                                        var blob = new Blob([byteArray], { type: mimeType });
                                        var blobUrl = URL.createObjectURL(blob);


                                        viewer.html('<iframe src="' + blobUrl + '" style="width:100%; height:500px;" frameborder="0"></iframe>');
                                    } else if (mimeType.startsWith('image/')) {

                                        viewer.html('<img src="data:' + mimeType + ';base64,' + data.base64 + '" style="width:100%;"/>');
                                    } else {
                                        var blob = b64toBlob(data.base64, mimeType);
                                        var url = window.URL.createObjectURL(blob);
                                        window.open(url, '_blank');
                                    }
                                    $("#myModalAttachment").modal("show");
                                } else {

                                    window.location = '/Common/AttachmentDownload?fileName=' + data.message;
                                    Swal.fire('Success', 'Document Downloaded successfully', 'success');
                                }
                            } else {
                                Swal.fire('Warning', data.message, 'warning');
                            }
                            HideProgress();
                        },
                        error: function (err) {
                            HideProgress();
                            Swal.fire('Error', err.responseText || 'An error occurred', 'error');
                        }
                    });
                };

                function b64toBlob(base64, contentType) {
                    var byteCharacters = atob(base64);
                    var byteArrays = [];

                    for (var offset = 0; offset < byteCharacters.length; offset += 512) {
                        var slice = byteCharacters.slice(offset, offset + 512);

                        var byteNumbers = new Array(slice.length);
                        for (var i = 0; i < slice.length; i++) {
                            byteNumbers[i] = slice.charCodeAt(i);
                        }

                        var byteArray = new Uint8Array(byteNumbers);
                        byteArrays.push(byteArray);
                    }

                    return new Blob(byteArrays, { type: contentType });
                }

                var UpdateBankDetails = function () {
                    $("#labelF3").text("Update Bank Details");
                    ShowProgress();
                    $.ajax({
                        async: true,
                        type: "POST",
                        datatype: "json",
                        contentType: "application/json; charset = utf-8",
                        processData: false,
                        url: '/Common/UpdateBankDetails',
                        success: function (data) {
                            $("#modalBody").html(data);
                            HideProgress();
                            $("#myModal").modal("show");
                        },
                        error: function (err) {
                            HideProgress();
                            Swal.fire('Warning', err, 'warning');
                        }
                    });
                }

                function DeleteNextOfKinLine(employeeCode, relationship, lineNo, id) {
                    Swal.fire({
                        title: 'Are you sure?',
                        text: "You won't be able to revert this!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, delete it!'
                    }).then((result) => {
                        if (result.isConfirmed) {

                            ShowProgress();
                            $.ajax({
                                type: "POST",
                                url: "/Dashboard/DeleteNextOfKinLine",
                                data: JSON.stringify({
                                    employeeCode: employeeCode,
                                    relationship: relationship,
                                    lineNo: lineNo,
                                    id: id
                                }),
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                success: function (data) {
                                    HideProgress();
                                    if (data.success) {
                                        $("#myModal").modal("hide");
                                        Swal.fire('Success', data.message, 'success');
                                        LoadNextOfKin();
                                    } else {
                                        Swal.fire('Warning', data.message, 'warning');
                                    }
                                },
                                error: function (err) {
                                    HideProgress();
                                    Swal.fire('Warning', err.responseText, 'warning');
                                }
                            });
                        }
                    });
                }
        </script>

    }

}
